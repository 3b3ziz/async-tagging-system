
> async-tagging-system@0.0.0 start:consumers /Users/ahmed.abdelaziz/3b3ziz/my-tagger
> tsx jobs/startConsumers.ts

[Main] Starting consumer services...
Attempting to connect to RabbitMQ at amqp://guest:guest@localhost:5672...
Attempting to connect to RabbitMQ at amqp://guest:guest@localhost:5672...
(node:49922) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
RabbitMQ connected successfully.
Attempting to create RabbitMQ channel...
RabbitMQ connected successfully.
Attempting to create RabbitMQ channel...
RabbitMQ channel created successfully.
RabbitMQ channel created successfully.
Exchange 'app_events' asserted.
Exchange 'app_events' asserted.
[Consumer][post.created] Asserting queue: post_created_queue
[Consumer][post.created] Binding queue post_created_queue to exchange app_events with key post.created
[Consumer][post.interacted] Queue 'post_interacted_queue' asserted and bound to 'app_events' with key 'post.interacted'. Waiting for messages...
[Consumer][post.created] Waiting for messages in post_created_queue. To exit press CTRL+C
[Consumer][post.interacted] Consumer started successfully.
Initializing Neo4j driver for URI: neo4j://localhost:7687 and database: neo4j
[Consumer][post.interacted] Processing event: User user-2 like Post 101
[Main] All consumers started successfully. Waiting for messages...
[post.created] Received message
[validatePostCreatedMessage] Received data (type): string
[validatePostCreatedMessage] Received data (start): {"postId":"102","userId":"user-2","text":"Neo4j graph databases are powerful for connected data. #ne
[validatePostCreatedMessage] Parsed data type: object
[validatePostCreatedMessage] Attempting to validate with Zod...
[validatePostCreatedMessage] Zod validation successful.
[post.created] Generating tags for: Neo4j graph databases are powerful for connected d...
[OpenAI] Fetching tags for text starting with: Neo4j graph databases are powerful for connected d...
Neo4j driver connected successfully.
[Consumer][post.interacted] Stored interaction: User user-2 like Post 101
[Consumer][post.interacted] Acknowledged message for interaction: User user-2 like Post 101
[post.created] Received message
[validatePostCreatedMessage] Received data (type): string
[validatePostCreatedMessage] Received data (start): {"postId":"101","userId":"user-1","text":"Exploring RabbitMQ for async communication! #rabbitmq #nod
[validatePostCreatedMessage] Parsed data type: object
[validatePostCreatedMessage] Attempting to validate with Zod...
[validatePostCreatedMessage] Zod validation successful.
[post.created] Generating tags for: Exploring RabbitMQ for async communication! #rabbi...
[OpenAI] Fetching tags for text starting with: Exploring RabbitMQ for async communication! #rabbi...
[OpenAI] Successfully generated tags: [ 'rabbitmq', 'async_communication', 'nodejs' ]
[post.created] Generated tags: [ 'rabbitmq', 'async_communication', 'nodejs' ]
[Neo4j] Linking post ID 101 to tags: rabbitmq, async_communication, nodejs
[Neo4j] Successfully linked post ID 101 to tags.
[post.created] Successfully processed message for post ID: 101
[post.created] Received message
[validatePostCreatedMessage] Received data (type): string
[validatePostCreatedMessage] Received data (start): {"postId":"102","userId":"user-2","text":"Neo4j graph databases are powerful for connected data. #ne
[validatePostCreatedMessage] Parsed data type: object
[validatePostCreatedMessage] Attempting to validate with Zod...
[validatePostCreatedMessage] Zod validation successful.
[post.created] Generating tags for: Neo4j graph databases are powerful for connected d...
[OpenAI] Fetching tags for text starting with: Neo4j graph databases are powerful for connected d...
[OpenAI] Successfully generated tags: [ 'neo4j', 'graphdb', 'connected_data' ]
[post.created] Generated tags: [ 'neo4j', 'graphdb', 'connected_data' ]
[Neo4j] Linking post ID 102 to tags: neo4j, graphdb, connected_data
[Neo4j] Successfully linked post ID 102 to tags.
[post.created] Successfully processed message for post ID: 102
RabbitMQ channel error: Channel closed by server: 406 (PRECONDITION-FAILED) with message "PRECONDITION_FAILED - unknown delivery tag 1"
RabbitMQ channel closed.
[OpenAI] Successfully generated tags: [ 'neo4j', 'graphdb', 'connected_data' ]
[post.created] Generated tags: [ 'neo4j', 'graphdb', 'connected_data' ]
[Neo4j] Linking post ID 102 to tags: neo4j, graphdb, connected_data
[Neo4j] Successfully linked post ID 102 to tags.
[post.created] Error processing message: IllegalOperationError: Channel closed
    at Channel.<anonymous> (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/channel.js:373:11)
    at Channel.ack (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/channel_model.js:213:10)
    at handlePostCreated (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/jobs/consumers/postCreatedConsumer.ts:40:11)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5) {
  stackAtStateChange: 'Stack capture: Channel closed by server: 406 (PRECONDITION-FAILED) with message "PRECONDITION_FAILED - unknown delivery tag 1"\n' +
    '    at Channel.accept (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/channel.js:330:15)\n' +
    '    at Connection.mainAccept [as accept] (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:579:33)\n' +
    '    at Socket.go (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:431:16)\n' +
    '    at Socket.emit (node:events:524:28)\n' +
    '    at emitReadable_ (node:internal/streams/readable:834:12)\n' +
    '    at process.processTicksAndRejections (node:internal/process/task_queues:89:21)'
}
[post.created] Error nacking message: IllegalOperationError: Channel closed
    at Channel.<anonymous> (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/channel.js:373:11)
    at Channel.nack (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/channel_model.js:223:10)
    at handlePostCreated (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/jobs/consumers/postCreatedConsumer.ts:46:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5) {
  stackAtStateChange: 'Stack capture: Channel closed by server: 406 (PRECONDITION-FAILED) with message "PRECONDITION_FAILED - unknown delivery tag 1"\n' +
    '    at Channel.accept (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/channel.js:330:15)\n' +
    '    at Connection.mainAccept [as accept] (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:579:33)\n' +
    '    at Socket.go (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:431:16)\n' +
    '    at Socket.emit (node:events:524:28)\n' +
    '    at emitReadable_ (node:internal/streams/readable:834:12)\n' +
    '    at process.processTicksAndRejections (node:internal/process/task_queues:89:21)'
}
SIGTERM received. Shutting down gracefully...
Closing RabbitMQ resources...
[Main] SIGTERM received. Shutting down gracefully...
Closing RabbitMQ resources...
Closing Neo4j driver...
Error closing RabbitMQ connection: IllegalOperationError: Connection closing
    at Connection.<anonymous> (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:634:11)
    at Connection.closeBecause (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:287:10)
    at Connection.close (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:280:10)
    at node:internal/util:455:21
    at new Promise (<anonymous>)
    at bound close (node:internal/util:441:12)
    at ChannelModel.close (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/channel_model.js:26:66)
    at closeRabbitMQ (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/jobs/rabbitmqClient.ts:94:24)
    at shutdown (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/jobs/startConsumers.ts:19:7) {
  stackAtStateChange: 'Stack capture: closeBecause called: Cheers, thanks\n' +
    '    at Connection.closeBecause (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:292:13)\n' +
    '    at Connection.close (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/connection.js:280:10)\n' +
    '    at node:internal/util:455:21\n' +
    '    at new Promise (<anonymous>)\n' +
    '    at bound close (node:internal/util:441:12)\n' +
    '    at ChannelModel.close (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/node_modules/.pnpm/amqplib@0.10.7/node_modules/amqplib/lib/channel_model.js:26:66)\n' +
    '    at closeRabbitMQ (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/jobs/rabbitmqClient.ts:94:24)\n' +
    '    at shutdown (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/jobs/rabbitmqClient.ts:106:9)\n' +
    '    at process.<anonymous> (/Users/ahmed.abdelaziz/3b3ziz/my-tagger/jobs/rabbitmqClient.ts:111:29)'
}
Neo4j driver closed successfully.
[Main] All connections closed.
